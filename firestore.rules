rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserRole() {
      return isAuthenticated() ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role : null;
    }
    
    function isAdmin() {
      return getUserRole() == 'admin';
    }
    
    function isActiveUser() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'active';
    }
    
    function hasRole(role) {
      return getUserRole() == role;
    }
    
    // Validation functions
    function isValidEmail(email) {
      return email.matches('^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$');
    }
    
    function isValidLeadStatus(status) {
      return status in ['new', 'contacted', 'qualified', 'converted', 'lost'];
    }
    
    function isValidProjectStatus(status) {
      return status in ['draft', 'published', 'archived'];
    }
    
    function isValidUserRole(role) {
      return role in ['user', 'admin', 'lead', 'qualified_lead', 'client', 'past_client'];
    }
    
    function isValidUserStatus(status) {
      return status in ['active', 'suspended', 'deleted'];
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can create their own profile when they first sign up
      allow create: if isOwner(userId) &&
        request.resource.data.id == userId &&
        isValidEmail(request.resource.data.email) &&
        isValidUserRole(request.resource.data.role) &&
        request.resource.data.role == 'lead'; // New users always start as leads
      
      // Users can update their own profile (except role)
      allow update: if isOwner(userId) &&
        request.resource.data.role == resource.data.role &&
        request.resource.data.id == resource.data.id;
      
      // Admins can do everything
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Leads collection
    match /leads/{leadId} {
      // Only admins can read leads
      allow read: if isAdmin();
      
      // Anyone can create a lead (public contact form)
      // But certain fields are restricted
      allow create: if 
        request.resource.data.keys().hasAll(['name', 'email', 'message', 'createdAt']) &&
        isValidEmail(request.resource.data.email) &&
        request.resource.data.status == 'new' &&
        request.resource.data.score >= 0 &&
        request.resource.data.score <= 100 &&
        request.resource.data.createdAt == request.time;
      
      // Only admins can update leads
      allow update: if isAdmin() &&
        isValidLeadStatus(request.resource.data.status);
      
      // Only admins can delete leads
      allow delete: if isAdmin();
      
      // Subcollection for lead notes
      match /notes/{noteId} {
        allow read: if isAdmin();
        allow create: if isAdmin() &&
          request.resource.data.authorId == request.auth.uid &&
          request.resource.data.createdAt == request.time;
        allow update: if false; // Notes are immutable
        allow delete: if isAdmin();
      }
    }
    
    // Projects collection
    match /projects/{projectId} {
      // Anyone can read published projects
      allow read: if resource.data.status == 'published' || isAdmin();
      
      // Only admins can create projects
      allow create: if isAdmin() &&
        isValidProjectStatus(request.resource.data.status) &&
        request.resource.data.createdBy == request.auth.uid &&
        request.resource.data.createdAt == request.time;
      
      // Only admins can update projects
      allow update: if isAdmin() &&
        isValidProjectStatus(request.resource.data.status) &&
        request.resource.data.updatedBy == request.auth.uid &&
        request.resource.data.updatedAt == request.time;
      
      // Only admins can delete projects
      allow delete: if isAdmin();
    }
    
    // Analytics collection
    match /analytics/{eventId} {
      // Only admins can read analytics
      allow read: if isAdmin();
      
      // Anyone can create analytics events (for tracking)
      allow create: if 
        request.resource.data.keys().hasAll(['type', 'sessionId', 'context', 'timestamp']) &&
        request.resource.data.timestamp == request.time;
      
      // Analytics events are immutable
      allow update: if false;
      
      // Only admins can delete analytics
      allow delete: if isAdmin();
    }
    
    // Admin-only collections
    match /settings/{document=**} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    match /logs/{document=**} {
      allow read: if isAdmin();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if isAdmin();
    }
    
    // Questionnaire sessions collection
    match /questionnaire_sessions/{sessionId} {
      // Users can read their own sessions
      allow read: if isOwner(sessionId) || isAdmin();
      
      // Users can create and update their own sessions
      allow create: if isOwner(sessionId) &&
        request.resource.data.userId == request.auth.uid;
      
      allow update: if isOwner(sessionId) &&
        request.resource.data.userId == resource.data.userId;
      
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}